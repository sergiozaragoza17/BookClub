{% extends 'base.html.twig' %}

{% block title %}Book{% endblock %}

{% block body %}
    <div class="container text-center" style="border: 1px solid black; border-radius: 10px; padding: 1%">
        <h1>{{ book.title|capitalize }}</h1>
        <hr>

        {% if book.coverImage %}
            <img src="{{ book.coverImage }}" alt="{{ book.title }}" class="img-thumbnail" width="150">
            {#    {% else %}#}
            {#        <img src="/images/default-profile.png" alt="Default Profile" class="img-thumbnail" width="150">#}
        {% endif %}
        <p><strong>Author:</strong> {{ book.author ?? 'Not set' }}</p>
        <p> {{ book.description ?? 'Not set' }}</p>
        <p><strong>Published year:</strong> {{ book.publishedYear ?? 'Not set' }}</p>
        <p><strong>Status:</strong> {{ userBook.status ?? 'Not set' }}</p>
        <p><b>Reviews:</b></p>

        {% if reviews %}

            {% set hasVisibleReviews = false %}

            <div class="row g-3">
                {% for review in reviews %}
                    {% if is_granted('ROLE_ADMIN') or review.status == 'approved' or (review.status in ['pending','rejected'] and user.id == review.user.id) %}
                        <div class="col-md-4">
                            <div class="card review-card {% if review.status == 'pending' %}bg-light text-dark{% elseif review.status == 'rejected' %}bg-danger bg-opacity-25 text-dark{% endif %}">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">
                                        {% if review.user.id != user.id %}
                                            <a href="{{ path('user_profile', {'id': review.user.id}) }}">
                                                {{ review.user.userName ?? 'Anonymous' }}
                                            </a>
                                        {% else %}
                                            {{ review.user.userName ?? 'Anonymous' }}
                                        {% endif %}
                                        {% if review.status == 'pending' %}
                                            (Pending)
                                        {% elseif review.status == 'rejected' %}
                                            (Rejected)
                                        {% endif %}
                                        {% if review.edited %}(Edited){% endif %}
                                    </h6>
                                    {% if review.content|length > 100 %}
                                    <p class="card-text">{{ review.content|slice(0, 100) ~ '...' }}</p>
                                        {# TODO poner boton de ver completa en reviews de book show #}
                                    {% else %}
                                        {{ review.content }}
                                    {% endif %}
                                    <div class="d-flex align-items-center mb-2">
                                        {% for i in 1..5 %}
                                            {% if i <= review.rating %}
                                                <i class="bi bi-star-fill text-warning"></i>
                                            {% else %}
                                                <i class="bi bi-star text-secondary"></i>
                                            {% endif %}
                                        {% endfor %}
                                    </div>

                                    {% if is_granted('ROLE_ADMIN') %}
                                        {% if review.status != 'approved' %}
                                            <a class="btn btn-sm btn-success" href="{{ path('admin_review_approve', {'id': review.id, 'redirect': 'book_show'}) }}">Approve</a>
                                        {% endif %}
                                        {% if review.status != 'rejected' %}
                                            <a class="btn btn-sm btn-warning" href="{{ path('admin_review_reject', {'id': review.id, 'redirect': 'book_show'}) }}">Reject</a>
                                        {% endif %}
                                        <form method="post"
                                              action="{{ path('admin_review_delete', {id: review.id}) }}"
                                              style="display:inline;"
                                              data-confirm="Are you sure you want to delete this review?"
                                              data-confirm-title="Delete"
                                              data-confirm-action="delete">
                                            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ review.id) }}">
                                            <button class="btn btn-sm btn-danger">Delete</button>
                                        </form>
                                    {% elseif user.id == review.user.id %}
                                        <a class="btn btn-sm btn-info" href="{{ path('review_edit', {'id': review.id}) }}">Edit Review</a>
                                        <form method="post"
                                              action="{{ path('review_delete', {id: review.id}) }}"
                                              style="display:inline;"
                                              data-confirm="Are you sure you want to delete this review?"
                                              data-confirm-title="Delete"
                                              data-confirm-action="delete">
                                            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ review.id) }}">
                                            <button class="btn btn-sm btn-danger">Delete Review</button>
                                        </form>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% set hasVisibleReviews = true %}
                    {% endif %}
                {% endfor %}
            </div>

            {% if not hasVisibleReviews %}
                <p><b>No reviews yet ...</b></p>
            {% endif %}

        {% else %}
            <p><b>No reviews yet ...</b></p>
        {% endif %}
    </div>
    <div class="container mt-3 mb-3 d-flex justify-content-between align-items-center">
        <div>
            {% if app.request.get('fromList') %}
                <a class="btn btn-info" href="{{ path('book_index') }}">Back to list</a>
            {% else %}
                <button class="btn btn-info" onclick="window.history.back();">Back</button>
            {% endif %}

            {% if is_granted('ROLE_ADMIN') %}
                <a class="btn btn-info" href="{{ path('book_edit', {'id': book.id}) }}">
                    Edit
                </a>
            {% elseif userBook is not null %}
                {% if userBook.status == 'finished' %}
                    <div class="d-inline-block" data-bs-toggle="tooltip" title="You have already finished this book">
                        <button class="btn btn-secondary" disabled>
                            Edit Status
                        </button>
                    </div>
                {% else %}
                    <a class="btn btn-info" href="{{ path('book_edit', {'id': book.id, 'redirect': 'book_show'}) }}">
                        Edit Status
                    </a>
                {% endif %}
            {% endif %}

            {% if not is_granted('ROLE_ADMIN') %}
                {% if userBook is null %}
                    <div class="d-inline-block" data-bs-toggle="tooltip" title="Add the book to your library first">
                        <button class="btn btn-secondary" disabled>
                            Write a review
                        </button>
                    </div>
                    {% include 'userbook/add_to_library_button.html.twig' with {'book': book} %}

                {% elseif userBook.status != 'finished' %}
                    <div class="d-inline-block" data-bs-toggle="tooltip" title="Mark the book as finished to review">
                        <button class="btn btn-secondary" disabled>
                            Write a review
                        </button>
                    </div>

                {% else %}
                    <a class="btn btn-info" href="{{ path('review_new', {'book': book.id}) }}">
                        Write a review
                    </a>
                {% endif %}
            {% endif %}
        </div>
        <div>
            {% if is_granted('ROLE_ADMIN') %}
                <form method="post"
                      action="{{ path('book_delete', {id: book.id}) }}"
                      style="display:inline;"
                      data-confirm="Are you sure you want to permanently delete this book and all its data?"
                      data-confirm-title="Delete"
                      data-confirm-action="delete">
                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ book.id) }}">
                    <button class="btn btn-danger">Delete Book</button>
                </form>

            {% elseif userBook %}
                <form method="post"
                      action="{{ path('book_remove', {id: book.id}) }}"
                      style="display:inline;"
                      data-confirm="Are you sure you want to remove this book from your library?"
                      data-confirm-title="Remove from Library"
                      data-confirm-action="remove">
                    <input type="hidden" name="_token" value="{{ csrf_token('remove' ~ book.id) }}">
                    <button class="btn btn-warning">Remove from Library</button>
                </form>

            {% endif %}
        </div>

    </div>
{% endblock %}
